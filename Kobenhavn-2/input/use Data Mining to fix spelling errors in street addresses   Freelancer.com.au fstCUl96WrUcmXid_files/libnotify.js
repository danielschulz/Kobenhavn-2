(function(){var a=function(a){var b,c=!1,d=[],e=[],f=[],g=5,h={last:undefined,first:undefined,packets:{}},i=function(a,b){h.packets[a]={id:b,next:undefined},h.packets[h.first].next=a,h.first=a},j=function(a){var b=h.last,c=h.packets[b],d=c.next;i(a,a),h.last=d,delete h.packets[b],delete c},k=function(a){return!h.packets[a]||h.packets[a].id!==a};(function(){var a;h.packets[0]={id:!1,next:undefined},h.first=0,h.last=0;for(a=1;a<=g;a++)i(a,!1)})();var l=function(b){var c=b.parent_type+':'+b.type;if(k(b.id)){j(b.id);var d=!0;a(f[c]).each(function(a,c){if(c(b)===!1)return d=!1,!1});if(!d)return!1;a(e[c]).each(function(c,d){var e=a.extend(!0,{},b);d(e)})}},m=function(a,b,c){var d=a+':'+b;if(e[d]){var f=_.find(e[d],function(a){return a==c});f||e[d].push(c)}else e[d]=new Array(c);return this},n=function(a,b,c){var d=a+':'+b;if(f[d]){var e=_.find(f[d],function(a){return a==c});e||f[d].push(c)}else f[d]=new Array(c);return this},o=function(a,b,e){e=e||window,b=b||[],c?a.apply(e,b):d.push({f:a,args:b,context:e})},p=function(){for(var a=0;a<d.length;a++){var b=d[a];b.f.apply(b.context,b.args)}d=[]},q=function(a,c){b.send(JSON.stringify({channel:a,body:c}))},r=function(){b&&b.close()},s=function(a,b,c){this.name=a,this.first_fail=!0,this.first_timeout=c,this.wait_time=b,this.reset_time=b};s.prototype.fail=function(){var a;return this.first_fail?(this.first_fail=!1,a=this.first_timeout):(a=this.wait_time,this.wait_time*=2),console.log(this.name+' Failed retrying in '+a),a},s.prototype.ok=function(){this.first_fail||console.log(this.name+' Recovered'),this.first_fail=!0,this.wait_time=this.reset_time};var t=function(a){var d,e=new s('sockJS Connect',1e3,200),f=new s('sockJS Reconnect',1e3,200),g=new s('sockJS Auth',4e3,500),h={hash:getCookie(flns.config.cookie_base+'_AUTH_HASH'),hash2:getCookie(flns.config.cookie_base+'_AUTH_HASH_V2'),user_id:getCookie(flns.config.cookie_base+'_USER_ID'),channels:flns.user_jobs};if(h.hash2==''&&h.hash==''||h.user_id=='')return!1;var i=function(){b=new SockJS(flns.config.notify_server),b.onmessage=function(d){var e=JSON.parse(d.data);e.channel=='user'?l(e.body):e.channel=='subscribe'&&(f.ok(),e.body=='NO'?(a(),b.close(4e3,'Auth Failure')):(g.ok(),c=!0,p()))},b.onopen=function(){e.ok(),b.send(JSON.stringify({channel:'auth',body:h}))},b.onclose=function(a){c=!1,a.code===4e3?setTimeout(i,g.fail()):a.wasClean?setTimeout(i,f.fail()):setTimeout(i,e.fail())}};i()};return t(function(){console.log('auth failure')}),{log:!0,register:m,register_filter:n,close:r,packets:h,send:q,ready:o}};typeof define=='function'&&define.amd?define(['jquery-wrapper','notification/sockjs'],a):window.libnotify=a(jQuery)})()